#!/bin/bash

if [[ $# -eq 4 ]]; then
    img=$1
    efi=$2
    mnt=$3

    if [[ $4 =~ ^/ ]]; then
        remote_path=$(echo $4 | sed -E 's|^(.*/).*$|\1|')
        remote_file=$(echo $4 | sed -E 's|^.*/||')
    else
        remote_path=/
        remote_file=$4
    fi
elif [[ $# -eq 3 ]]; then
    img=$1
    efi=$2
    mnt=$3
    remote_path=/EFI/BOOT/
    remote_file=BOOTX64.EFI
else
    echo "cp-uefi <img> <efi-file> <mnt-point> [<remote-file-path>]" >&2
    exit 1
fi

if [[ ! -f $img ]]; then
    echo "Missing <img> file ($img)" >&2
    exit 1
fi

if [[ ! -f $efi ]]; then
    echo "Missing <efi> file ($efi)" >&2
    exit 1
fi

if [[ ! -d $mnt ]]; then
    echo "Missing <mnt> directory ($mnt)" >&2
    exit 1
fi


sudo losetup --offset 1048576 /dev/loop0 $img
sudo mount /dev/loop0 $mnt
sudo mkdir -p ${mnt}${remote_path}
echo "Performing copy $efi -> ${mnt}${remote_path}${remote_file}"
sudo cp $efi ${mnt}${remote_path}${remote_file}
sudo umount $mnt
sudo losetup -d /dev/loop0

echo "Done."
